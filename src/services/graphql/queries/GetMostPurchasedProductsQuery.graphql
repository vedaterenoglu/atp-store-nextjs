query GetMostPurchasedProducts(
  $company_id: String!
  $customer_id: String!
  $bd: date!
  $ed: date!
) {
  goods_transactions(
    where: {
      goods_transactions_dispatch_haeaders_rel: {
        company_id: { _eq: $company_id }
        customer_id: { _eq: $customer_id }
        dispatch_date: { _gte: $bd, _lte: $ed }
      }
    }
    distinct_on: stock_id
  ) {
    stock_id
    goods_transactions_stock_rel {
      stock_id
      stock_name
      stock_price
      stock_unit
      stock_group
      stock_image_link
    }
    goods_transaction_goods_transaction_rel_aggregate(
      where: {
        goods_transactions_dispatch_haeaders_rel: {
          company_id: { _eq: $company_id }
          customer_id: { _eq: $customer_id }
          dispatch_date: { _gte: $bd, _lte: $ed }
        }
      }
    ) {
      aggregate {
        sum {
          amount_credit
        }
      }
    }
  }
  goods_transactions_aggregate(
    where: {
      goods_transactions_dispatch_haeaders_rel: {
        company_id: { _eq: $company_id }
        customer_id: { _eq: $customer_id }
        dispatch_date: { _gte: $bd, _lte: $ed }
      }
    }
  ) {
    aggregate {
      count(columns: stock_id, distinct: true)
    }
  }
}

# Variables:
# - bd (begin date): calculated as today - NEXT_PUBLIC_CONSUMPTION_PERIOD_IN_DAYS
# - ed (end date): today
#
# Example:
# {
#   "company_id": "alfe",
#   "customer_id": "SE0 1001 1086",
#   "bd": "2025-05-07",
#   "ed": "2025-08-06"
# }
